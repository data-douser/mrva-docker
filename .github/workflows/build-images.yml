name: Build and Publish MRVA Docker Images

on:
  push:
    branches: [master]
    paths:
      - 'containers/**'
      - '.github/workflows/build-images.yml'
    tags:
      - 'v*'
  pull_request:
    branches: [master]
    paths:
      - 'containers/**'
      - '.github/workflows/build-images.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  # Determine which images to build
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.filter.outputs.images }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine images to build
        id: filter
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag push - build all images
            echo 'images=["server", "agent", "hepc", "ghmrva", "vscode"]' >> $GITHUB_OUTPUT
          else
            # Detect changed directories
            IMAGES='[]'
            for dir in server agent hepc ghmrva vscode; do
              if [ -d "containers/$dir" ]; then
                IMAGES=$(echo $IMAGES | jq -c ". + [\"$dir\"]")
              fi
            done
            echo "images=$IMAGES" >> $GITHUB_OUTPUT
          fi

  build-server:
    name: Build MRVA Server
    runs-on: ubuntu-latest
    needs: changes
    if: contains(fromJson(needs.changes.outputs.images), 'server')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout mrva-docker
        uses: actions/checkout@v6

      - name: Checkout mrvaserver
        uses: actions/checkout@v6
        with:
          repository: hohn/mrvaserver
          path: containers/server/mrvaserver

      - name: Checkout mrvacommander
        uses: actions/checkout@v6
        with:
          repository: hohn/mrvacommander
          path: containers/server/mrvacommander

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/codeql-mrva-server
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: ./containers/server
          labels: ${{ steps.meta.outputs.labels }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}

  build-agent:
    name: Build MRVA Agent
    runs-on: ubuntu-latest
    needs: changes
    if: contains(fromJson(needs.changes.outputs.images), 'agent')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout mrva-docker
        uses: actions/checkout@v6

      - name: Checkout mrvaagent
        uses: actions/checkout@v6
        with:
          repository: hohn/mrvaagent
          path: containers/agent/mrvaagent

      - name: Checkout mrvacommander
        uses: actions/checkout@v6
        with:
          repository: hohn/mrvacommander
          path: containers/agent/mrvacommander

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/codeql-mrva-agent
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: ./containers/agent
          labels: ${{ steps.meta.outputs.labels }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}

  build-hepc:
    name: Build HEPC (Go)
    runs-on: ubuntu-latest
    needs: changes
    if: contains(fromJson(needs.changes.outputs.images), 'hepc')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout mrva-docker
        uses: actions/checkout@v6

      - name: Checkout mrva-go-hepc
        uses: actions/checkout@v6
        with:
          repository: data-douser/mrva-go-hepc
          path: containers/hepc/mrva-go-hepc

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/codeql-mrva-hepc
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: ./containers/hepc/mrva-go-hepc
          labels: ${{ steps.meta.outputs.labels }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}

  build-ghmrva:
    name: Build gh-mrva Client
    runs-on: ubuntu-latest
    needs: changes
    if: contains(fromJson(needs.changes.outputs.images), 'ghmrva')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout mrva-docker
        uses: actions/checkout@v6

      - name: Checkout gh-mrva
        uses: actions/checkout@v6
        with:
          repository: hohn/gh-mrva
          path: containers/ghmrva/gh-mrva

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/codeql-mrva-ghmrva
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: ./containers/ghmrva
          labels: ${{ steps.meta.outputs.labels }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}

  build-vscode:
    name: Build VS Code Server
    runs-on: ubuntu-latest
    needs: changes
    if: contains(fromJson(needs.changes.outputs.images), 'vscode')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout mrva-docker
        uses: actions/checkout@v6

      - name: Checkout vscode-codeql
        uses: actions/checkout@v6
        with:
          repository: hohn/vscode-codeql
          ref: mrva-standalone
          path: vscode-codeql

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: vscode-codeql/extensions/ql-vscode/.nvmrc

      - name: Build vscode-codeql extension
        working-directory: vscode-codeql/extensions/ql-vscode
        run: |
          npm install -g @vscode/vsce
          npm install
          npm run build

      - name: Copy extension to artifacts
        run: |
          mkdir -p containers/vscode/artifacts
          # Find and copy the built VSIX file
          VSIX_FILE=$(find vscode-codeql/dist -name "vscode-codeql-*.vsix" -type f | head -n 1)
          if [ -z "$VSIX_FILE" ]; then
            echo "Error: No vscode-codeql VSIX file found in vscode-codeql/dist/"
            exit 1
          fi
          echo "Found VSIX file: $VSIX_FILE"
          cp "$VSIX_FILE" containers/vscode/artifacts/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/codeql-mrva-vscode
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: ./containers/vscode
          labels: ${{ steps.meta.outputs.labels }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-server, build-agent, build-hepc, build-ghmrva, build-vscode]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| codeql-mrva-server | ${{ needs.build-server.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| codeql-mrva-agent | ${{ needs.build-agent.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| codeql-mrva-hepc | ${{ needs.build-hepc.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| codeql-mrva-ghmrva | ${{ needs.build-ghmrva.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| codeql-mrva-vscode | ${{ needs.build-vscode.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
