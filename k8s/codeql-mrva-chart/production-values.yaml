# Production Values for CodeQL MRVA Helm Chart
# This file contains production-ready configuration overrides
# Usage: helm install mrva ./k8s/codeql-mrva-chart -f production-values.yaml --namespace mrva

# Global settings
global:
  namespace: mrva
  annotations:
    app.kubernetes.io/managed-by: helm
  labels:
    environment: production
  imagePullSecrets:
    - name: ghcr-secret
  imagePullPolicy: IfNotPresent

# =============================================================================
# MRVA Server Configuration
# =============================================================================
server:
  enabled: true
  replicaCount: 2
  image:
    repository: ghcr.io/data-douser/codeql-mrva-server
    tag: "latest"
    pullPolicy: IfNotPresent
  args:
    - "--mode=container"
    - "--loglevel=info"
  service:
    type: ClusterIP
    port: 8080
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 256Mi
  readinessProbe:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 10
    periodSeconds: 10
  livenessProbe:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 30
    periodSeconds: 30

# =============================================================================
# MRVA Agent Configuration
# =============================================================================
agent:
  enabled: true
  replicaCount: 3  # Scale agents for parallel analysis
  image:
    repository: ghcr.io/data-douser/codeql-mrva-agent
    tag: "latest"
    pullPolicy: IfNotPresent
  args:
    - "--loglevel=info"
    - "--workers=2"
  resources:
    limits:
      cpu: 4000m
      memory: 8Gi
    requests:
      cpu: 1000m
      memory: 2Gi

# =============================================================================
# HEPC (Go Implementation) Configuration
# =============================================================================
hepc:
  enabled: true
  replicaCount: 2
  image:
    repository: ghcr.io/data-douser/codeql-mrva-hepc
    tag: "latest"
    pullPolicy: IfNotPresent
  # Override command for Go binary (replaces Python hepc-serve-global)
  command:
    - "hepc-server"
    - "--storage"
    - "gcs"
    - "--host"
    - "0.0.0.0"
    - "--port"
    - "8070"
  # Additional args can be set via environment or extended command
  # For GCS: add --gcs-bucket via env HEPC_GCS_BUCKET
  service:
    type: ClusterIP
    port: 8070
  cacheDuration: "60"
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi
  # GCS configuration (add to deployment env)
  gcs:
    bucket: ""  # Set via --set hepc.gcs.bucket=your-bucket
    prefix: ""
    # credentials handled via workload identity or mounted secret

# =============================================================================
# PostgreSQL Configuration
# =============================================================================
postgres:
  enabled: true
  image:
    repository: postgres
    tag: "15"
  auth:
    username: "mrva"
    # Password should be overridden via --set or secrets
    password: ""  # Set via: --set postgres.auth.password=xxx
    database: "mrvadb"
  persistence:
    enabled: true
    storageClass: ""  # Use cluster default
    size: 50Gi
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 250m
      memory: 512Mi

# =============================================================================
# MinIO Configuration
# =============================================================================
minio:
  enabled: true
  image:
    repository: minio/minio
    tag: "RELEASE.2024-06-11T03-13-30Z"
  rootUser: "mrva"
  # Password should be overridden via --set or secrets
  rootPassword: ""  # Set via: --set minio.rootPassword=xxx
  bucketName: "mrvabucket"
  virtualHostStyle: "0"
  persistence:
    enabled: true
    storageClass: ""
    size: 100Gi
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 250m
      memory: 512Mi
  initJob:
    enabled: true

# =============================================================================
# RabbitMQ Configuration
# =============================================================================
rabbitmq:
  enabled: true
  image:
    repository: rabbitmq
    tag: "3.13.7-management"
  auth:
    username: "mrva"
    # Password should be overridden via --set or secrets
    password: ""  # Set via: --set rabbitmq.auth.password=xxx
  persistence:
    enabled: true
    storageClass: ""
    size: 10Gi
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 256Mi
  healthcheck:
    enabled: true
    initialDelaySeconds: 60
    periodSeconds: 30

# =============================================================================
# Optional Components (Disabled by Default in Production)
# =============================================================================
codeServer:
  enabled: false

ghmrva:
  enabled: false

# =============================================================================
# Ingress Configuration
# =============================================================================
ingress:
  enabled: true
  className: "nginx"  # Adjust for your cluster
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
  hosts:
    - host: mrva.example.com  # Replace with your domain
      paths:
        - path: /
          pathType: Prefix
          service: server
  tls:
    - secretName: mrva-tls
      hosts:
        - mrva.example.com

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  automount: true
  annotations:
    # For GKE Workload Identity:
    # iam.gke.io/gcp-service-account: mrva@PROJECT.iam.gserviceaccount.com
  name: "mrva"

# =============================================================================
# Network Policy
# =============================================================================
networkPolicy:
  enabled: true
